-- Project: Comprehensive EHR and Financial Data Analysis

-- Step 1: Create Schema
CREATE SCHEMA ehr_financial_data;

-- Step 2: Create Tables
CREATE TABLE ehr_financial_data.patients (
    patient_id INT64 PRIMARY KEY,
    name STRING,
    dob DATE,
    gender STRING,
    address STRING,
    insurance_provider STRING,
    admission_date DATE,
    discharge_date DATE,
    diagnosis_code STRING
);

CREATE TABLE ehr_financial_data.diagnosis_codes (
    code STRING PRIMARY KEY,
    description STRING
);

CREATE TABLE ehr_financial_data.procedures (
    procedure_id INT64 PRIMARY KEY,
    patient_id INT64,
    procedure_date DATE,
    procedure_code STRING,
    procedure_description STRING,
    procedure_cost FLOAT64,
    performing_doctor_id INT64,
    FOREIGN KEY (patient_id) REFERENCES ehr_financial_data.patients(patient_id)
);

CREATE TABLE ehr_financial_data.transactions (
    transaction_id INT64 PRIMARY KEY,
    patient_id INT64,
    transaction_date DATE,
    amount FLOAT64,
    transaction_type STRING,
    FOREIGN KEY (patient_id) REFERENCES ehr_financial_data.patients(patient_id)
);

CREATE TABLE ehr_financial_data.insurance_plans (
    plan_id INT64 PRIMARY KEY,
    plan_name STRING,
    coverage_type STRING,
    coverage_amount FLOAT64
);

CREATE TABLE ehr_financial_data.healthcare_providers (
    provider_id INT64 PRIMARY KEY,
    provider_name STRING,
    specialty STRING,
    address STRING,
    contact_number STRING
);

CREATE TABLE ehr_financial_data.lab_results (
    result_id INT64 PRIMARY KEY,
    patient_id INT64,
    test_date DATE,
    test_type STRING,
    result_value FLOAT64,
    unit STRING,
    FOREIGN KEY (patient_id) REFERENCES ehr_financial_data.patients(patient_id)
);

CREATE TABLE ehr_financial_data.admissions (
    admission_id INT64 PRIMARY KEY,
    patient_id INT64,
    admission_date DATE,
    discharge_date DATE,
    admission_type STRING,
    discharge_type STRING,
    FOREIGN KEY (patient_id) REFERENCES ehr_financial_data.patients(patient_id)
);

CREATE TABLE ehr_financial_data.medical_staff (
    staff_id INT64 PRIMARY KEY,
    name STRING,
    role STRING,
    specialty STRING
);

-- Step 3: Load Data
-- Load EHR data, diagnosis codes, procedures, financial transactions, insurance plans, healthcare provider information, lab results, admissions data, medical staff information, and more into respective tables.

-- Load Patients Data
INSERT INTO ehr_financial_data.patients (patient_id, name, dob, gender, address, insurance_provider, admission_date, discharge_date, diagnosis_code)
VALUES
    (1, 'John Doe', '1980-05-25', 'Male', '123 Main St', 'ABC Insurance', '2022-01-01', '2022-01-05', 'ICD-10-CM Code 1'),
    (2, 'Jane Smith', '1975-09-15', 'Female', '456 Elm St', 'XYZ Insurance', '2022-01-03', '2022-01-08', 'ICD-10-CM Code 2'),
    -- Add more rows as needed
    ;

-- Load Diagnosis Codes Data
INSERT INTO ehr_financial_data.diagnosis_codes (code, description)
VALUES
    ('ICD-10-CM Code 1', 'Description for ICD-10-CM Code 1'),
    ('ICD-10-CM Code 2', 'Description for ICD-10-CM Code 2'),
    -- Add more rows as needed
    ;

-- Load Procedures Data
-- Assuming similar INSERT statements for other tables...

-- Step 4: Data Cleaning and Preparation
-- Clean the data by removing duplicates, handling missing values, and ensuring data consistency.

-- Handling Missing Values
UPDATE ehr_financial_data.patients
SET dob = '1900-01-01'
WHERE dob IS NULL;

-- Removing Duplicates
DELETE FROM ehr_financial_data.patients
WHERE patient_id IN (
    SELECT patient_id
    FROM (
        SELECT patient_id, ROW_NUMBER() OVER (PARTITION BY patient_id ORDER BY patient_id) AS rn
        FROM ehr_financial_data.patients
    ) AS t
    WHERE rn > 1
);

-- Data Standardization
UPDATE ehr_financial_data.patients
SET gender = UPPER(gender);

-- Handling Outliers
DELETE FROM ehr_financial_data.procedures
WHERE procedure_cost > (SELECT AVG(procedure_cost) + 3 * STDDEV(procedure_cost) FROM ehr_financial_data.procedures);

-- Data Validation
SELECT *
FROM ehr_financial_data.procedures
WHERE procedure_code NOT IN (SELECT code FROM ehr_financial_data.diagnosis_codes);

-- Correcting Inconsistencies
UPDATE ehr_financial_data.healthcare_providers
SET specialty = 'General Medicine'
WHERE specialty = 'Internal Medicine';

-- Step 5: Perform Statistical Analysis
-- Conduct advanced statistical analyses to extract meaningful insights from the data.

-- Example 1: Calculate total revenue by insurance provider
WITH insurance_revenue AS (
    SELECT
        p.insurance_provider,
        SUM(t.amount) AS total_revenue
    FROM
        ehr_financial_data.patients p
    JOIN
        ehr_financial_data.transactions t
    ON
        p.patient_id = t.patient_id
    GROUP BY
        p.insurance_provider
)
SELECT
    insurance_provider,
    total_revenue
FROM
    insurance_revenue
ORDER BY
    total_revenue DESC;

-- Example 2: Identify patients with high procedure costs
SELECT
    patient_id,
    SUM(procedure_cost) AS total_procedure_cost
FROM
    ehr_financial_data.procedures
GROUP BY
    patient_id
HAVING
    total_procedure_cost > (SELECT AVG(procedure_cost) * 2 FROM ehr_financial_data.procedures)
ORDER BY
    total_procedure_cost DESC;

-- Example 3: Calculate average transaction amount by gender and insurance type
SELECT
    p.gender,
    p.insurance_provider,
    AVG(t.amount) AS avg_transaction_amount
FROM
    ehr_financial_data.patients p
JOIN
    ehr_financial_data.transactions t
ON
    p.patient_id = t.patient_id
GROUP BY
    p.gender, p.insurance_provider;

-- Example 4: Identify top-performing healthcare providers based on total revenue generated
WITH provider_revenue AS (
    SELECT
        h.provider_id,
        hp.provider_name,
        SUM(t.amount) AS total_revenue
    FROM
        ehr_financial_data.healthcare_providers hp
    JOIN
        ehr_financial_data.procedures h
    ON
        hp.provider_id = h.performing_doctor_id
    JOIN
        ehr_financial_data.transactions t
    ON
        h.patient_id = t.patient_id
    GROUP BY
        h.provider_id, hp.provider_name
)
SELECT
    provider_id,
    provider_name,
    total_revenue
FROM
    provider_revenue
ORDER BY
    total_revenue DESC
LIMIT 10; -- Top 10 providers

-- Example 5: Calculate average length of stay in hospital
SELECT
    AVG(DATE_DIFF(discharge_date, admission_date, DAY)) AS avg_length_of_stay
FROM
    ehr_financial_data.admissions;

-- Step 6: Advanced SQL Techniques
-- Utilize advanced SQL techniques to perform complex analyses and optimize query performance.

-- Example 6: Calculate moving average of transaction amounts
SELECT
    transaction_date,
    amount,
    AVG(amount) OVER (ORDER BY transaction_date ROWS BETWEEN 4 PRECEDING AND CURRENT ROW) AS moving_avg_amount
FROM
    ehr_financial_data.transactions
ORDER BY
    transaction_date;

-- Example 7: Use recursive CTE to generate patient treatment history
WITH RECURSIVE patient_history AS (
    SELECT
        patient_id,
        procedure_date,
        procedure_code,
        procedure_description,
        procedure_cost,
        performing_doctor_id
    FROM
        ehr_financial_data.procedures
    UNION ALL
    SELECT
        p.patient_id,
        p.procedure_date,
        p.procedure_code,
        p.procedure_description,
        p.procedure_cost,
        p.performing_doctor_id
    FROM
        ehr_financial_data.procedures p
    JOIN
        patient_history ph
    ON
        p.patient_id = ph.patient_id
)
SELECT
    patient_id,
    procedure_date,
    procedure_code,
    procedure_description,
    procedure_cost,
    performing_doctor_id
FROM
    patient_history;

-- Step 7: Optimization
-- Optimize query performance through indexing, partitioning, and materialized views.

-- Example 8: Create indexes for frequently queried columns
CREATE INDEX idx_patient_id ON ehr_financial_data.transactions(patient_id);
CREATE INDEX idx_patient_id ON ehr_financial_data.procedures(patient_id);

-- Example 9: Partition large tables for improved query speed
CREATE TABLE ehr_financial_data.transactions_partitioned
PARTITION BY patient_id
AS
SELECT
    *
FROM
    ehr_financial_data.transactions;

-- Example 10: Create materialized views for complex queries
CREATE MATERIALIZED VIEW ehr_financial_data.patient_summary
AS
SELECT
    patient_id,
    COUNT(transaction_id) AS transaction_count,
    SUM(amount) AS total_transaction_amount
